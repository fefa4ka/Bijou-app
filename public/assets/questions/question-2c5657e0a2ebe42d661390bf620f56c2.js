$(function(){function a(a){$(".b-form__questionnaire").text(a[0].questionnaire),$.tmpl("tmpl-question",a).appendTo(".b-form__questions"),$("input").customInput(),$(".b-form__questions_container").removeClass("l-hidden"),$(".b-form__questions div:first").addClass("selected ui-corner-all"),b(a[0]),$(".b-form__question__action_button").live("click",function(){log("set submit action",$(this).attr("action")),e=$(this).attr("action")})}function b(a){log("prepare");switch(a.answer_type){case 4:log("mao"),d();break;case 6:c()}}function c(){$(".b-form__question.selected .b-form__question_date").datepicker({onSelect:function(a,b){$(".b-form__question_date_input").val($(this).datepicker("getDate").toUTCString())}})}function d(){function g(b,c){var d=new YMaps.Geocoder(b,{results:1,boundedBy:a.getBounds()}),e;YMaps.Events.observe(d,d.Events.Load,function(){this.length()?(e=this.get(0),c(e)):alert("Ничего не найдено")}),YMaps.Events.observe(d,d.Events.Fault,function(a,b){alert("Произошла ошибка: "+b)})}function h(b){function c(b){var c=new YMaps.Placemark(b,{draggable:!0,style:"default#buildingsIcon"});return a.addOverlay(c),c}function d(){YMaps.Events.observe(h,h.Events.BalloonOpen,function(b){function c(){var a=".b-form__question_map_list";e="",$('<li class="b-form__question_map_item"/>').append($("<p/>").text(i)).append($('<input class="address" type="hidden" name="question[answer][places][address][]"/>').val(i)).append($('<input class="geopoint" type="hidden" name="question[answer][places][geopoint][]"/>').val(h.getGeoPoint().toString())).attr("item_id",j).appendTo(a).click(function(){h.openBalloon()}),h.closeBalloon(),$(this).removeClass("blue_action").addClass("red_action").val("Удалить место").click(d)}function d(){$(".b-form__question_map_item[item_id="+j+"]").remove(),a.removeOverlay(h)}l||($(".b-question__map_balloon_button_"+j).click(k?d:c).customInput(),log(j,l,k),l=!0,k=!0)}),YMaps.Events.observe(h,h.Events.DragStart,function(a){prev=a.getGeoPoint().copy()}),YMaps.Events.observe(h,h.Events.Drag,function(a){var b=a.getGeoPoint().copy()}),YMaps.Events.observe(h,h.Events.DragEnd,function(a){a.update(),g(a.getGeoPoint(),function(a){var b={id:j,address:a.text,saved:k};i=b.text,f(b),$(".b-form__question_map_item[item_id="+j+"]").find("p").text(a.text),$(".b-form__question_map_item[item_id="+j+"]").find("input.address").val(a.text),$(".b-form__question_map_item[item_id="+j+"]").find("input.geopoint").val(a.getGeoPoint().toString()),l=0})})}function f(a){var b=$("<div/>");$.tmpl("tmpl-question__map_balloon",a).appendTo(b),h.setBalloonContent(b.html())}var h=typeof b!="string"?c(b):"",i,j=(new Date).getTime(),k=!1,l;g(b,function(e){var g={id:j,address:e.text};i=e.text,typeof b=="string"&&(h=c(e.getGeoPoint())),d(),f(g),h.openBalloon(),a.setBounds(e.getBounds()),$(".b-form__question.selected .b-form__question_map_search").val("")}),a.removeOverlay(e),e=h}function j(a){h(a)}log("generate map",$(".b-form__question.selected .b-form__question_yandex_map"));var a=new YMaps.Map($(".b-form__question.selected .b-form__question_yandex_map")),b=new YMaps.SmallZoom,c=10,d,e,f=[];$.template("tmpl-question__map_balloon",'<div class="b-question__map_balloon t-strong">${address}</div> \t\t\t\t\t\t\t\t\t\t\t      <input type="button" class="b-question__map_balloon_button b-question__map_balloon_button_${id} {{if saved}}red_action{{else}}blue_action{{/if}}" value="{{if saved}}Удалить место{{else}}Добавить место{{/if}}">'),YMaps.location?d=new YMaps.GeoPoint(YMaps.location.longitude,YMaps.location.latitude):d=new YMaps.GeoPoint(37.64,55.76),a.enableDblClickZoom(),a.addControl(b),a.setCenter(d,c),$(".b-form__question.selected .b-form__question_map_search").length!=0&&($(".b-form__question_search_button").click(function(){var a=$(".b-form__question.selected .b-form__question_map_search").val();j(a)}),$(".b-form__question.selected .b-form__question_map_search").autocomplete({minLength:2,source:function(b,c){var d=a.getCenter().toString(),e=a.getBounds().getSpan().toString();$.ajax({url:"/add_missing/address_suggest.json",dataType:"jsonp",data:{part:b.term,ll:d,spn:e},success:function(a){c($.map(a[1],function(a){var b=a[1],c=a[2];label="";for(i in b){var a=b[i];typeof a=="object"&&a instanceof Array?label+="<b>"+a[1]+"</b>":label+=a}return{label:label,value:c}}))}})},select:function(a,b){$(".b-form__question.selected .b-form__question_map_search").val(b.item.value)}}).keydown(function(a){if(a.keyCode==13)return $(".b-form__question_search_button").click(),!1}).data("autocomplete")._renderItem=function(a,b){return $("<li></li>").data("item.autocomplete",b).append("<a>"+b.label+"</a>").appendTo(a)}),$(".b-form__question.selected .b-form__question__action_button").click(function(){a.destructor()})}var e;$.template("tmpl-question",'<div class="b-form__question l-left {{if answer_type == 4}}map{{/if}}"> \t\t\t\t\t<form accept-charset="UTF-8" action="/add_missing/answer_the_question.json" data-remote="true" class="b-form__question_form answer_the_question" method="post"> \t\t\t\t\t<input type="hidden" name="question[id]" value="${id}"> \t\t\t\t \t<div class="b-form__label">${text}</div> \t\t\t\t\t<div class="b-form__question_answer"> \t\t\t\t\t \t{{if answer_type == 0}} \t\t\t\t\t\t \t{{tmpl "tmpl-question__yes-no-dontknow"}} \t\t\t\t\t\t {{else answer_type == 1 || answer_type == 2}} \t\t\t\t\t\t \t{{tmpl "tmpl-question__one_any"}} \t\t\t\t\t\t {{else answer_type == 3}} \t\t\t\t\t\t \t{{tmpl "tmpl-question__free"}} \t\t\t\t\t\t {{else answer_type == 4}} \t\t\t\t\t\t\t{{tmpl "tmpl-question__map"}} \t\t\t\t\t\t{{else answer_type == 6}} \t\t\t\t\t\t\t{{tmpl "tmpl-question__date"}} \t\t\t\t\t\t {{/if}} \t\t\t\t\t\t {{if answer_type != 0}} \t\t\t\t\t\t\t<div class="clear"></div> \t\t\t\t\t\t    {{tmpl "tmpl-question__actions"}} \t\t\t\t\t\t {{/if}} \t\t\t\t\t </div> \t\t\t\t\t </form> \t\t\t\t </div>'),$.template("tmpl-question__one_any",'<ul class="b-form__question_answers_list"> \t\t\t\t {{if answer_type == 1}} \t\t\t\t \t {{tmpl "tmpl-question__one_items"}} \t\t\t\t\t {{if other}} \t\t\t\t\t <li class="b-form__question_answers_list__item {{if answers.length > 4}}half{{/if}}"> \t\t\t\t\t \t<input id="question_answer_id_other_${id}" name="question[answer][id]" type="radio" value="other" /> <label for="question_answer_id_other_${id}">другое</label><br> \t\t\t\t\t \t<input type="text" name="question[answer][text]"> \t\t\t\t\t </li> \t\t\t\t\t {{/if}} \t\t\t\t {{else answer_type == 2}} \t\t\t\t \t {{tmpl "tmpl-question__any_items"}} \t\t\t\t\t {{if other}} \t\t\t\t\t <li class="b-form__question_answers_list__item {{if answers.length > 4}}half{{/if}}">другое<br><input type="text" name="question[answer][text]"></li> \t\t\t\t\t {{/if}} \t\t\t\t {{/if}} \t\t\t\t </ul>'),$.template("tmpl-question__any_items",'{{each answers}} \t\t\t\t <li class="b-form__question_answers_list__item {{if $item.parent.data.answers.length > 4}}half{{/if}}"> \t\t\t\t <input type="checkbox" id="question_answers_ids_${$value.id}" name="question[answer][answers_ids][${$value.id}]"><label for="question_answers_ids_${$value.id}">${$value.text}</label> \t\t\t\t </li> \t\t\t\t {{/each}}'),$.template("tmpl-question__one_items",'{{each answers}} \t\t\t\t <li class="b-form__question_answers_list__item {{if $item.parent.data.answers.length > 4}}half{{/if}}">        \t\t\t\t<input id="question_answer_id_${$value.id}" name="question[answer][id]" type="radio" value="${$value.id}" /> <label for="question_answer_id_${$value.id}">${$value.text}</label>     \t\t\t </li> \t\t\t\t {{/each}}'),$.template("tmpl-question__free",'<textarea name="question[answer][text]" class="b-form__question_answer_free"></textarea>'),$.template("tmpl-question__actions",'<div class="clear"></div> \t\t\t\t <div class="b-form__question__actions"> \t\t\t\t <input type="submit" value="Ответить" class="b-form__question__action_button" action="answer"> \t\t\t\t <input type="submit" value="Отложить вопрос" class="b-form__question__action_button next_question silver_action l-right"  action="skip"> \t\t\t\t </div>'),$.template("tmpl-question__yes-no-dontknow",'<input type="submit" value="Да" class="b-form__question__action_button" action="yes"> \t\t\t\t <input type="submit" value="Нет" class="b-form__question__action_button" action="no"> \t\t\t\t <input type="submit" value="Отложить вопрос" class="b-form__question__action_button next_question silver_action l-right" action="skip">'),$.template("tmpl-question__map",'<table class="b-form__question_map"> \t\t\t\t <tr> \t\t\t\t <td class="b-form__question_map_container"> \t\t\t\t \t<div class="b-form__question_search_container"> \t\t\t\t\t\t<input type="text" class="b-form__question_map_search" placeholder="Адрес места"><input type="button" class="b-form__question_search_button" value="Найти"> \t\t\t\t\t</div> \t\t\t\t \t<div class="b-form__question_yandex_map"></div> \t\t\t\t\t<p class="b-form__field_description">Чтобы уточнить место, можно перетащить метку.</p> \t\t\t\t </td> \t\t\t\t <td> \t\t\t\t\t<p>Вы можете добавить несколько мест</p> \t\t\t\t\t<ul class="b-form__question_map_list"> \t\t\t\t\t</ul> \t\t\t\t </td></tr> \t\t\t\t </table>'),$.template("tmpl-question__date",'<div class="b-form__question_date"></div> \t\t\t\t <input class="b-form__question_date_input" type="hidden" name="question[answer][date]">'),$(".answer_the_question").live("ajax:beforeSend",function(a,b,c){c.data+="&question[action_type]="+e}).live("ajax:success",function(a,c,d,e){function f(){$(this).remove()}function g(){log("construct"),$(this).addClass("selected").removeAttr("style"),b(k)}var h=$(this).parents("div.b-form__question"),i=h.next(),j=i.find('input[name="question[id]"]').val(),k=c.question,l=0,m=h.outerWidth()*-1-50,n=0;if(k==null){$(".b-form__questions_infinity").remove(),$(".b-form__questions_finish").removeClass("l-hidden"),h.effect("drop",{queue:!1},500,f);return}k.id==j?(h.effect("drop",{queue:!1},500,f),i.find(".b-form__question_answer").show("slide",{direction:"up",queue:!1},500),i.animate({marginLeft:m},500,"linear",g)):k.id>0&&(l=$.tmpl("tmpl-question",k).addClass("selected").hide().prependTo(".b-form__questions").show("slide",{direction:"up"},500,g),h.remove(),$("input").customInput()),$(".b-form__questionnaire").text(k.questionnaire)}),typeof questions!="undefined"&&questions.length>0&&a(questions)})